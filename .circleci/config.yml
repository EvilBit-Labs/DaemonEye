# CircleCI 2.1 configuration converted from GitHub Actions workflow
# Maintains parity with .github/workflows/ci.yml functionality
version: 2.1

orbs:
    codecov: codecov/codecov@5.4.3
    win: circleci/windows@5.1.0
    macos: circleci/macos@2.5.4

# Reusable cache commands for different operating systems
commands:
    restore_cargo_cache_linux:
        steps:
            - restore_cache:
                  keys:
                      - cargo-v1-linux-{{ arch }}-{{ checksum "Cargo.lock" }}
                      - cargo-v1-linux-{{ arch }}-
                      - cargo-v1-linux-

    save_cargo_cache_linux:
        steps:
            - save_cache:
                  key: cargo-v1-linux-{{ arch }}-{{ checksum "Cargo.lock" }}
                  paths:
                      - ~/.cargo/registry
                      - ~/.cargo/git
                      - ~/.cargo/bin
                      - target

    restore_cargo_cache_macos:
        steps:
            - restore_cache:
                  keys:
                      - cargo-v1-macos-{{ arch }}-{{ checksum "Cargo.lock" }}
                      - cargo-v1-macos-{{ arch }}-
                      - cargo-v1-macos-

    save_cargo_cache_macos:
        steps:
            - save_cache:
                  key: cargo-v1-macos-{{ arch }}-{{ checksum "Cargo.lock" }}
                  paths:
                      - ~/.cargo/registry
                      - ~/.cargo/git
                      - ~/.cargo/bin
                      - target

    restore_cargo_cache_windows:
        steps:
            - restore_cache:
                  keys:
                      - cargo-v1-windows-{{ checksum "Cargo.lock" }}
                      - cargo-v1-windows-

    save_cargo_cache_windows:
        steps:
            - save_cache:
                  key: cargo-v1-windows-{{ checksum "Cargo.lock" }}
                  paths:
                      - C:\\Users\\circleci\\.cargo\\registry
                      - C:\\Users\\circleci\\.cargo\\git
                      - C:\\Users\\circleci\\project\\target

# Global environment variables
common_env: &common_env
    CARGO_TERM_COLOR: always
    CI: true

jobs:
    # Code quality checks - rustfmt and clippy
    quality:
        docker:
            - image: cimg/rust:1.89
        environment:
            <<: *common_env
        steps:
            - checkout
            - restore_cargo_cache_linux

            # Install protoc for protobuf compilation
            - run:
                  name: Install protoc
                  command: |
                      sudo apt-get update
                      sudo apt-get install -y protobuf-compiler

            # Rustfmt check (equivalent to actions-rust-lang/rustfmt@v1)
            - run:
                  name: Rustfmt Check
                  command: cargo fmt -- --check

            # Clippy check with warnings as errors (matches GHA: cargo clippy --all-targets --all-features -- -D warnings)
            - run:
                  name: Clippy (all features)
                  command: cargo clippy --all-targets --all-features -- -D warnings

            - save_cargo_cache_linux

    # Basic test job - mirrors GitHub Actions "test" job
    test:
        docker:
            - image: cimg/rust:1.89
        environment:
            <<: *common_env
        steps:
            - checkout
            - restore_cargo_cache_linux

            # Install protoc for protobuf compilation
            - run:
                  name: Install protoc
                  command: |
                      sudo apt-get update
                      sudo apt-get install -y protobuf-compiler

            # Install cargo-nextest (matches taiki-e/install-action@v2)
            - run:
                  name: Install cargo-nextest
                  command: cargo install cargo-nextest --locked

            # Run tests with nextest (matches GHA: cargo nextest run --all-features)
            - run:
                  name: Run tests (all features)
                  command: cargo nextest run --all-features

            # Build release binary (matches GHA: cargo build --release --all-features)
            - run:
                  name: Build release
                  command: cargo build --release --all-features

            - save_cargo_cache_linux
            - store_test_results:
                  path: target/nextest
            - store_artifacts:
                  path: target/nextest

    # Cross-platform testing - Linux (Primary Support)
    test-cross-platform-linux-ubuntu-latest:
        docker:
            - image: cimg/rust:1.89
        environment:
            <<: *common_env
        steps:
            - checkout
            - restore_cargo_cache_linux

            # Install protoc for protobuf compilation
            - run:
                  name: Install protoc
                  command: |
                      sudo apt-get update
                      sudo apt-get install -y protobuf-compiler

            - run:
                  name: Install cargo-nextest
                  command: if ! command -v cargo-nextest &> /dev/null; then cargo install cargo-nextest --locked; fi

            # Matches GHA matrix job: cargo nextest run --all-features
            - run:
                  name: Run tests (all features)
                  command: cargo nextest run --all-features

            # Matches GHA: cargo build --release --all-features
            - run:
                  name: Build release (all features)
                  command: cargo build --release --all-features

            - save_cargo_cache_linux

    # Cross-platform testing - Linux (Secondary Support - Ubuntu 22.04)
    # Note: Ubuntu 20.04, 18.04, RHEL 7, FreeBSD testing would require custom runners
    test-cross-platform-linux-ubuntu-22:
        docker:
            - image: cimg/rust:1.89
        environment:
            <<: *common_env
        steps:
            - checkout
            - restore_cargo_cache_linux

            # Install protoc for protobuf compilation
            - run:
                  name: Install protoc
                  command: |
                      sudo apt-get update
                      sudo apt-get install -y protobuf-compiler

            - run:
                  name: Install cargo-nextest
                  command: if ! command -v cargo-nextest &> /dev/null; then cargo install cargo-nextest --locked; fi

            # Matches GHA matrix job: cargo nextest run --all-features
            - run:
                  name: Run tests (all features)
                  command: cargo nextest run --all-features

            # Matches GHA: cargo build --release --all-features
            - run:
                  name: Build release (all features)
                  command: cargo build --release --all-features

            - save_cargo_cache_linux

    # Cross-platform testing - macOS (Primary Support)
    test-cross-platform-macos:
        macos:
            xcode: 15.4.0
        environment:
            <<: *common_env
        steps:
            - checkout
            - restore_cargo_cache_macos

            # Install protoc for protobuf compilation
            - run:
                  name: Install protoc
                  command: |
                      brew install protobuf

            # Install Rust toolchain on macOS
            - run:
                  name: Install Rust
                  command: |
                      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
                      echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> "$BASH_ENV"

            - run:
                  name: Install cargo-nextest
                  command: if ! command -v cargo-nextest &> /dev/null; then cargo install cargo-nextest --locked; fi

            - run:
                  name: Run tests (all features)
                  command: |
                      source "$BASH_ENV"
                      cargo nextest run --all-features

            - run:
                  name: Build release (all features)
                  command: |
                      source "$BASH_ENV"
                      cargo build --release --all-features

            - save_cargo_cache_macos

    # Cross-platform testing doesn't seem to work well on Windows
    # Note: Ubuntu 20.04, 18.04, RHEL 7, FreeBSD testing would require custom runners
    # Note: macOS 12 (Monterey) testing would require custom runners
    # Note: Windows Server 2019 testing would require custom runners

    # Coverage generation - mirrors GitHub Actions "coverage" job
    coverage:
        docker:
            - image: cimg/rust:1.89
        environment:
            <<: *common_env
        steps:
            - checkout
            - restore_cargo_cache_linux

            # Install protoc for protobuf compilation
            - run:
                  name: Install protoc
                  command: |
                      sudo apt-get update
                      sudo apt-get install -y protobuf-compiler

            # Install cargo-llvm-cov (matches taiki-e/install-action@v2)
            - run:
                  name: Install cargo-llvm-cov
                  command: |
                      rustup component add llvm-tools-preview
                      if ! command -v cargo-llvm-cov &> /dev/null; then cargo install cargo-llvm-cov --locked; fi

            # Generate coverage (matches GHA: cargo llvm-cov --all-features --no-report)
            - run:
                  name: Generate coverage
                  command: cargo llvm-cov --all-features --no-report

            # Combine coverage reports (matches GHA: cargo llvm-cov report --lcov --output-path lcov.info)
            - run:
                  name: Combine coverage reports
                  command: cargo llvm-cov report --lcov --output-path lcov.info

            - save_cargo_cache_linux
            - store_artifacts:
                  path: lcov.info

            # Upload to Codecov (matches codecov/codecov-action@v5)
            - codecov/upload:
                  files: lcov.info

workflows:
    ci:
        jobs:
            # Quality checks run first
            - quality:
                  filters:
                      branches:
                          only: /.*/
                      tags:
                          only: /.*/

            # Basic test job requires quality to pass
            - test:
                  requires:
                      - quality
                  filters:
                      branches:
                          only: /.*/
                      tags:
                          only: /.*/

            # Cross-platform tests require quality to pass (parallel to basic test)
            - test-cross-platform-linux-ubuntu-latest:
                  requires:
                      - quality
                  filters:
                      branches:
                          only: /.*/
                      tags:
                          only: /.*/

            - test-cross-platform-linux-ubuntu-22:
                  requires:
                      - quality
                  filters:
                      branches:
                          only: /.*/
                      tags:
                          only: /.*/

            - test-cross-platform-macos:
                  requires:
                      - quality
                  filters:
                      branches:
                          only: /.*/
                      tags:
                          only: /.*/

            # Coverage requires all tests to pass
            - coverage:
                  requires:
                      - quality
                  filters:
                      branches:
                          only: /.*/
                      tags:
                          only: /.*/
