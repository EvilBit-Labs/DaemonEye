# DaemonEye nextest configuration
# Documentation: https://nexte.st/docs/configuration/

[store]
# Store test results and metadata
dir = "target/nextest"

# =============================================================================
# TEST PROFILES
# =============================================================================

[profile.default]
# Default test execution settings
# Fail fast to quickly identify broken tests during development
fail-fast = true
# Run tests with moderate parallelism by default
test-threads = "num-cpus"
# Show test output for failures
failure-output = "immediate-final"
# Status level for test results
status-level = "pass"
# Timeout for individual tests (5 minutes default)
slow-timeout = { period = "60s", terminate-after = 2 }
# Retry flaky tests once
retries = 0

[profile.default.junit]
# JUnit XML output for CI integration
path = "target/nextest/default/junit.xml"
report-name = "daemoneye-tests"

# -----------------------------------------------------------------------------
# CI Profile - Optimized for continuous integration
# Usage: cargo nextest run --profile ci
# -----------------------------------------------------------------------------
[profile.ci]
# Don't fail fast in CI to get full test results
fail-fast = false
# Use all available CPUs in CI
test-threads = "num-cpus"
# Show all failures at the end
failure-output = "final"
# Higher timeout for CI environments (may be slower)
slow-timeout = { period = "120s", terminate-after = 3 }
# Retry flaky tests in CI
retries = 2

[profile.ci.junit]
path = "target/nextest/ci/junit.xml"
report-name = "daemoneye-ci-tests"
store-success-output = false
store-failure-output = true

# -----------------------------------------------------------------------------
# Coverage Profile - For running with llvm-cov
# Usage: cargo llvm-cov nextest --profile coverage
# -----------------------------------------------------------------------------
[profile.coverage]
# Coverage runs should be thorough
fail-fast = false
# Single-threaded for accurate coverage
test-threads = 1
# Extended timeout for coverage instrumentation overhead
slow-timeout = { period = "180s", terminate-after = 2 }
# No retries - we want deterministic results
retries = 0
failure-output = "immediate-final"

[profile.coverage.junit]
path = "target/nextest/coverage/junit.xml"
report-name = "daemoneye-coverage-tests"

# -----------------------------------------------------------------------------
# Fast Profile - Quick feedback during development
# Usage: cargo nextest run --profile fast
# -----------------------------------------------------------------------------
[profile.fast]
# Fail fast for quick feedback
fail-fast = true
# Maximum parallelism
test-threads = "num-cpus"
# Quick timeout
slow-timeout = { period = "30s", terminate-after = 1 }
# Don't retry
retries = 0
# Minimal output
status-level = "fail"
failure-output = "immediate"

# -----------------------------------------------------------------------------
# Heavy Profile - For resource-intensive tests
# Usage: cargo nextest run --profile heavy
# -----------------------------------------------------------------------------
[profile.heavy]
# Don't fail fast for long-running tests
fail-fast = false
# Limited parallelism to avoid resource contention
test-threads = 4
# Extended timeout for heavy tests
slow-timeout = { period = "300s", terminate-after = 2 }
# Retry once for flaky heavy tests
retries = 1
failure-output = "immediate-final"

[profile.heavy.junit]
path = "target/nextest/heavy/junit.xml"
report-name = "daemoneye-heavy-tests"

# =============================================================================
# TEST GROUPS - Control concurrency for specific test patterns
# =============================================================================

[test-groups.database-exclusive]
# Group for tests that require exclusive database access
max-threads = 1

[test-groups.ipc-tests]
# Group for IPC tests that may conflict
max-threads = 2

[test-groups.serial-tests]
# Group for resource-intensive benchmarks and serial tests
max-threads = 1

# =============================================================================
# OVERRIDES - Configure specific test patterns
# =============================================================================

# Database tests - run with limited concurrency
[[profile.default.overrides]]
filter = "test(database) | test(storage) | test(redb)"
test-group = "database-exclusive"
slow-timeout = { period = "120s", terminate-after = 2 }

# IPC tests - may have socket conflicts
[[profile.default.overrides]]
filter = "test(ipc) | test(rpc) | test(eventbus)"
test-group = "ipc-tests"
slow-timeout = { period = "120s", terminate-after = 2 }

# Integration tests - may need more time
[[profile.default.overrides]]
filter = "kind(test) & test(integration)"
slow-timeout = { period = "180s", terminate-after = 2 }
retries = 1

# Property-based tests - may be slow
[[profile.default.overrides]]
filter = "test(proptest) | test(property)"
slow-timeout = { period = "300s", terminate-after = 1 }
# Single thread for deterministic property tests
test-group = "serial-tests"

# Benchmark-related tests
[[profile.default.overrides]]
filter = "test(bench) | test(performance)"
test-group = "serial-tests"
slow-timeout = { period = "300s", terminate-after = 1 }

# Platform-specific tests
[[profile.default.overrides]]
filter = "test(linux) | test(macos) | test(windows)"
slow-timeout = { period = "120s", terminate-after = 2 }

# Lifecycle tests - may involve startup/shutdown delays
[[profile.default.overrides]]
filter = "test(lifecycle) | test(startup) | test(shutdown)"
slow-timeout = { period = "180s", terminate-after = 2 }
retries = 1

# Security tests - thorough checks
[[profile.default.overrides]]
filter = "test(security) | test(privilege) | test(injection)"
slow-timeout = { period = "120s", terminate-after = 2 }

# Chaos/stress tests - extended timeouts
[[profile.default.overrides]]
filter = "test(chaos) | test(stress) | test(backpressure)"
slow-timeout = { period = "300s", terminate-after = 1 }
test-group = "serial-tests"

# CI profile overrides - more lenient timeouts
[[profile.ci.overrides]]
filter = "all()"
slow-timeout = { period = "180s", terminate-after = 3 }

# Coverage profile overrides - extended timeouts for instrumented code
[[profile.coverage.overrides]]
filter = "all()"
slow-timeout = { period = "240s", terminate-after = 2 }
